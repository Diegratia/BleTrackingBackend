events {}

http {
    # DNS resolver untuk hostname dalam proxy_pass yang berbasis variabel
    resolver 127.0.0.11 ipv6=off valid=30s;
    resolver_timeout 5s;

    map $svc $upstream {
        default "";
        Auth                   http://auth:10001;
        UserGroup              http://auth:10001;
        FloorplanDevice        http://floorplan-device:10003;
        FloorplanMaskedArea    http://floorplan-masked-area:10004;
        MstAccessCctv          http://mst-accesscctv:10005;
        MstAccessControl       http://mst-accesscontrol:10006;
        MstApplication         http://mst-application:10007;
        MstBleReader           http://mst-blereader:10008;
        MstBrand               http://mst-brand:10009;
        MstBuilding            http://mst-building:10010;
        MstDepartment          http://mst-department:10011;
        MstDistrict            http://mst-district:10012;
        MstFloor               http://mst-floor:10013;
        MstFloorplan           http://mst-floorplan:10014;
        MstIntegration         http://mst-integration:10015;
        MstMember              http://mst-member:10016;
        MstOrganization        http://mst-organization:10017;
        TrackingTransaction    http://tracking-transaction:10018;
        Visitor                http://visitor:10019;
        VisitorBlacklistArea   http://visitor-blacklist-area:10020;
        BleReaderNode          http://ble-reader-node:10021;
        AlarmRecordTracking    http://alarm-record-tracking:10002;
        MstEngine              http://mst-engine:10022;
        CardRecord             http://card-record:10024;
        Card                   http://card:10026;
        TrxVisitor             http://trx-visitor:10025;
    }

    server {
        listen 10000;

        location ~ ^/api/(?<svc>[^/]+)/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-BIOPEOPLETRACKING-API-KEY' always;
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($upstream = "") { return 404; }

            proxy_set_header Host                      $host;
            proxy_set_header X-Real-IP                 $remote_addr;
            proxy_set_header X-Forwarded-For           $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto         $scheme;
            proxy_set_header X-BIOPEOPLETRACKING-API-KEY $http_x_biopeopletracking_api_key;
            proxy_pass_header X-BIOPEOPLETRACKING-API-KEY;
            proxy_set_header Authorization             $http_authorization;
            proxy_pass_header Authorization;

            proxy_pass $upstream;  
        }

        location /Uploads/BuildingImages/    { proxy_pass http://mst-building:10010; }
        location /Uploads/FloorImages/       { proxy_pass http://mst-floor:10013; }
        location /Uploads/MemberFaceImages/  { proxy_pass http://mst-member:10016; }
        location /Uploads/visitorFaceImages/ { proxy_pass http://visitor:10019; }
    }
}
