events {}

http {
    # DNS resolver untuk hostname dalam proxy_pass yang berbasis variabel
    resolver 127.0.0.11 ipv6=off valid=30s;
    resolver_timeout 5s;

    map $svc $upstream {
        default "";
        Auth                   http://auth:5001;
        UserGroup              http://auth:5001;
        FloorplanDevice        http://floorplan-device:5003;
        FloorplanMaskedArea    http://floorplan-masked-area:5004;
        MstAccessCctv          http://mst-accesscctv:5005;
        MstAccessControl       http://mst-accesscontrol:5006;
        MstApplication         http://mst-application:5007;
        MstBleReader           http://mst-blereader:5008;
        MstBrand               http://mst-brand:10009;
        MstBuilding            http://mst-building:5010;
        MstDepartment          http://mst-department:5011;
        MstDistrict            http://mst-district:5012;
        MstFloor               http://mst-floor:5013;
        MstFloorplan           http://mst-floorplan:5014;
        MstIntegration         http://mst-integration:5015;
        MstMember              http://mst-member:5016;
        MstOrganization        http://mst-organization:5017;
        TrackingTransaction    http://tracking-transaction:5018;
        Visitor                http://visitor:5019;
        VisitorBlacklistArea   http://visitor-blacklist-area:5020;
        BleReaderNode          http://ble-reader-node:5021;
        AlarmRecordTracking    http://alarm-record-tracking:5002;
        MstEngine              http://mst-engine:5022;
        CardRecord             http://card-record:5024;
        Card                   http://card:5026;  
        TrxVisitor             http://trx-visitor:5025;
        AlarmTriggers          http://alarm-triggers:5027;
        AlarmCategorySettings  http://alarm-triggers:5027;
        TimeGroup              http://card-access:5028;
        CardGroup              http://card-access:5028;
        CardAccess             http://card-access:5028;
        MonitoringConfig       http://monitoring-config:5029;
        Geofence               http://geofence:5030;
        Boundary               http://geofence:5030;
        StayOnArea             http://geofence:5030;
        Overpopulating         http://geofence:5030;
    }

    server {
        listen 5000;

        location ~ ^/api/MstFloorplan/ {
            client_max_body_size 50m;
            proxy_pass http://mst-floorplan:5014;
        }
        
        location ~ ^/api/(?<svc>[^/]+)/ {
            if ($request_method = OPTIONS) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, X-BIOPEOPLETRACKING-API-KEY' always;
                add_header 'Content-Length' 0;
                return 204;
            }

            if ($upstream = "") { return 404; }

            proxy_set_header Host                      $host;
            proxy_set_header X-Real-IP                 $remote_addr;
            proxy_set_header X-Forwarded-For           $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto         $scheme;
            proxy_set_header X-BIOPEOPLETRACKING-API-KEY $http_x_biopeopletracking_api_key;
            proxy_pass_header X-BIOPEOPLETRACKING-API-KEY;
            proxy_set_header Authorization             $http_authorization;
            proxy_pass_header Authorization;

    

            proxy_pass $upstream;  
        }

        location /Uploads/BuildingImages/    {
            client_max_body_size 5m; 
            proxy_pass http://mst-building:5010; 
            }
        location /Uploads/FloorplanImages/       { 
            client_max_body_size 50m;
            proxy_pass http://mst-floorplan:5014;
        }
        location /Uploads/MemberFaceImages/  { 
            client_max_body_size 5m;
            proxy_pass http://mst-member:5016; 
            }
        location /Uploads/visitorFaceImages/ {
            client_max_body_size 5m;
            proxy_pass http://visitor:5019;
            }
    }
    
}

