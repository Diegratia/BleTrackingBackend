<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <!-- Aktifkan ARR Proxy -->
    <proxy enabled="true" preserveHostHeader="true" />

    <!-- Izinkan request besar -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="52428800" /> <!-- 50MB -->
      </requestFiltering>
    </security>

    <!-- CORS Header -->
    <!-- <httpProtocol>
      <customHeaders>
        <add name="Access-Control-Allow-Origin" value="*" />
        <add name="Access-Control-Allow-Methods" value="GET, POST, PUT, DELETE, OPTIONS" />
        <add name="Access-Control-Allow-Headers" value="Authorization, Content-Type, X-BIOPEOPLETRACKING-API-KEY" />
      </customHeaders>
    </httpProtocol> -->

    <rewrite>
    <outboundRules rewriteBeforeCache="true">

    <!-- ðŸ§¹ Hapus semua header lama dari backend -->
    <rule name="Remove existing CORS headers">
      <match serverVariable="RESPONSE_Access-Control-Allow-Origin" pattern=".+" />
      <action type="Rewrite" value="" />
    </rule>
    <rule name="Remove existing CORS methods">
      <match serverVariable="RESPONSE_Access-Control-Allow-Methods" pattern=".+" />
      <action type="Rewrite" value="" />
    </rule>
    <rule name="Remove existing CORS headers list">
      <match serverVariable="RESPONSE_Access-Control-Allow-Headers" pattern=".+" />
      <action type="Rewrite" value="" />
    </rule>

    <!-- ðŸŒ Tambahkan header baru (pakai HTTP_ORIGIN dinamis, fallback ke *) -->
    <rule name="Add CORS Origin dynamic or wildcard">
      <match serverVariable="RESPONSE_Access-Control-Allow-Origin" pattern=".*" />
      <conditions>
        <add input="{HTTP_ORIGIN}" pattern=".+" />
      </conditions>
      <action type="Rewrite" value="{C:0}" />
    </rule>
    <rule name="Add CORS Origin wildcard fallback">
      <match serverVariable="RESPONSE_Access-Control-Allow-Origin" pattern=".*" />
      <conditions>
        <add input="{HTTP_ORIGIN}" pattern=".*" negate="true" />
      </conditions>
      <action type="Rewrite" value="*" />
    </rule>

    <!-- ðŸš€ Tambahkan header CORS lainnya -->
    <rule name="Add CORS Methods always">
      <match serverVariable="RESPONSE_Access-Control-Allow-Methods" pattern=".*" />
      <action type="Rewrite" value="GET, POST, PUT, DELETE, OPTIONS" />
    </rule>

    <rule name="Add CORS Headers always">
      <match serverVariable="RESPONSE_Access-Control-Allow-Headers" pattern=".*" />
      <action type="Rewrite" value="Authorization, Content-Type, X-BIOPEOPLETRACKING-API-KEY" />
    </rule>

  </outboundRules>
      <rules>

        <!-- Root path -->
        <rule name="RootCheck" stopProcessing="true">
          <match url="^$" />
          <action type="Rewrite" url="response.json" />
        </rule>

        <!-- Health Check -->
        <rule name="HealthCheck" stopProcessing="true">
          <match url="^hc$" />
          <action type="Rewrite" url="http://localhost:8080/hc" />
        </rule>

        <!-- Upload Routes -->
        <rule name="BuildingImages" enabled="true" stopProcessing="true">
          <match url="^Uploads/BuildingImages/(.*)" />
          <action type="Rewrite" url="http://localhost:5010/Uploads/BuildingImages/{R:1}" />
        </rule>

        <rule name="FloorplanImages" stopProcessing="true">
          <match url="^Uploads/FloorplanImages/(.*)" />
          <action type="Rewrite" url="http://localhost:5014/Uploads/FloorplanImages/{R:1}" />
        </rule>

        <rule name="MemberFaceImages" stopProcessing="true">
          <match url="^Uploads/MemberFaceImages/(.*)" />
          <action type="Rewrite" url="http://localhost:5016/Uploads/MemberFaceImages/{R:1}" />
        </rule>
        <rule name="SecurityFaceImages" stopProcessing="true">
          <match url="^Uploads/SecurityFaceImages/(.*)" />
          <action type="Rewrite" url="http://localhost:5016/Uploads/SecurityFaceImages/{R:1}" />
        </rule>

        <rule name="VisitorFaceImages" stopProcessing="true">
          <match url="^Uploads/visitorFaceImages/(.*)" />
          <action type="Rewrite" url="http://localhost:5019/Uploads/visitorFaceImages/{R:1}" />
        </rule>

        <!-- Floorplan direct -->
        <rule name="FloorplanDirect" stopProcessing="true">
          <match url="^api/MstFloorplan/?(.*)" />
          <action type="Rewrite" url="http://localhost:5014/api/MstFloorplan/{R:1}" />
        </rule>

        <!-- Dynamic API Proxy Rules -->
        <rule name="ApiProxyAuth" stopProcessing="true">
          <match url="^api/(Auth|UserGroup)/?(.*)" />
          <action type="Rewrite" url="http://localhost:5001/api/{R:1}/{R:2}" />
        </rule>

        <rule name="ApiProxyFloorplanDevice" stopProcessing="true">
          <match url="^api/FloorplanDevice/?(.*)" />
          <action type="Rewrite" url="http://localhost:5003/api/FloorplanDevice/{R:1}" />
        </rule>

        <rule name="ApiProxyFloorplanMaskedArea" stopProcessing="true">
          <match url="^api/FloorplanMaskedArea/?(.*)" />
          <action type="Rewrite" url="http://localhost:5004/api/FloorplanMaskedArea/{R:1}" />
        </rule>

        <rule name="ApiProxyMstAccessCctv" stopProcessing="true">
          <match url="^api/MstAccessCctv/?(.*)" />
          <action type="Rewrite" url="http://localhost:5005/api/MstAccessCctv/{R:1}" />
        </rule>

        <rule name="ApiProxyMstAccessControl" stopProcessing="true">
          <match url="^api/MstAccessControl/?(.*)" />
          <action type="Rewrite" url="http://localhost:5006/api/MstAccessControl/{R:1}" />
        </rule>

        <rule name="ApiProxyMstApplication" stopProcessing="true">
          <match url="^api/MstApplication/?(.*)" />
          <action type="Rewrite" url="http://localhost:5007/api/MstApplication/{R:1}" />
        </rule>

        <rule name="ApiProxyMstBleReader" stopProcessing="true">
          <match url="^api/MstBleReader/?(.*)" />
          <action type="Rewrite" url="http://localhost:5008/api/MstBleReader/{R:1}" />
        </rule>

        <rule name="ApiProxyMstBrand" stopProcessing="true">
          <match url="^api/MstBrand/?(.*)" />
          <action type="Rewrite" url="http://localhost:5009/api/MstBrand/{R:1}" />
        </rule>

        <rule name="ApiProxyTrackingPreset" stopProcessing="true">
          <match url="^api/tracking-presets/?(.*)" />
          <action type="Rewrite" url="http://localhost:5018/api/tracking-presets/{R:1}" />
        </rule>

        <rule name="ApiProxyMstBuilding" stopProcessing="true">
          <match url="^api/MstBuilding/?(.*)" />
          <action type="Rewrite" url="http://localhost:5010/api/MstBuilding/{R:1}" />
        </rule>

        <rule name="ApiProxyMstDepartment" stopProcessing="true">
          <match url="^api/MstDepartment/?(.*)" />
          <action type="Rewrite" url="http://localhost:5011/api/MstDepartment/{R:1}" />
        </rule>

        <rule name="ApiProxyMstDistrict" stopProcessing="true">
          <match url="^api/MstDistrict/?(.*)" />
          <action type="Rewrite" url="http://localhost:5012/api/MstDistrict/{R:1}" />
        </rule>

        <rule name="ApiProxyMstFloor" stopProcessing="true">
          <match url="^api/MstFloor/?(.*)" />
          <action type="Rewrite" url="http://localhost:5013/api/MstFloor/{R:1}" />
        </rule>

        <rule name="ApiProxyMstIntegration" stopProcessing="true">
          <match url="^api/MstIntegration/?(.*)" />
          <action type="Rewrite" url="http://localhost:5015/api/MstIntegration/{R:1}" />
        </rule>

        <rule name="ApiProxyMstMember" stopProcessing="true">
          <match url="^api/MstMember/?(.*)" />
          <action type="Rewrite" url="http://localhost:5016/api/MstMember/{R:1}" />
        </rule>
        <rule name="ApiProxyMstSecurity" stopProcessing="true">
          <match url="^api/MstSecurity/?(.*)" />
          <action type="Rewrite" url="http://localhost:5016/api/MstSecurity/{R:1}" />
        </rule>
        <rule name="ApiProxyMstOrganization" stopProcessing="true">
          <match url="^api/MstOrganization/?(.*)" />
          <action type="Rewrite" url="http://localhost:5017/api/MstOrganization/{R:1}" />
        </rule>

        <rule name="ApiProxyTrackingTransaction" stopProcessing="true">
          <match url="^api/TrackingTransaction/?(.*)" />
          <action type="Rewrite" url="http://localhost:5018/api/TrackingTransaction/{R:1}" />
        </rule>

        <rule name="ApiProxyVisitor" stopProcessing="true">
          <match url="^api/Visitor/?(.*)" />
          <action type="Rewrite" url="http://localhost:5019/api/Visitor/{R:1}" />
        </rule>

        <rule name="ApiProxyBleReaderNode" stopProcessing="true">
          <match url="^api/BleReaderNode/?(.*)" />
          <action type="Rewrite" url="http://localhost:5021/api/BleReaderNode/{R:1}" />
        </rule>

        <rule name="ApiProxyAlarmRecordTracking" stopProcessing="true">
          <match url="^api/AlarmRecordTracking/?(.*)" />
          <action type="Rewrite" url="http://localhost:5002/api/AlarmRecordTracking/{R:1}" />
        </rule>

        <rule name="ApiProxyMstEngine" stopProcessing="true">
          <match url="^api/MstEngine/?(.*)" />
          <action type="Rewrite" url="http://localhost:5022/api/MstEngine/{R:1}" />
        </rule>

        <rule name="ApiProxyCardRecord" stopProcessing="true">
          <match url="^api/CardRecord/?(.*)" />
          <action type="Rewrite" url="http://localhost:5024/api/CardRecord/{R:1}" />
        </rule>

        <rule name="ApiProxyTrxVisitor" stopProcessing="true">
          <match url="^api/TrxVisitor/?(.*)" />
          <action type="Rewrite" url="http://localhost:5025/api/TrxVisitor/{R:1}" />
        </rule>

        <rule name="ApiProxyCard" stopProcessing="true">
          <match url="^api/Card/?(.*)" />
          <action type="Rewrite" url="http://localhost:5026/api/Card/{R:1}" />
        </rule>

        <rule name="ApiProxyAlarmTriggers" stopProcessing="true">
          <match url="^api/(AlarmTriggers|AlarmCategorySettings)/?(.*)" />
          <action type="Rewrite" url="http://localhost:5027/api/{R:1}/{R:2}" />
        </rule>

        <rule name="ApiProxyCardAccess" stopProcessing="true">
          <match url="^api/(TimeGroup|TimeBlock|CardGroup|CardAccess)/?(.*)" />
          <action type="Rewrite" url="http://localhost:5028/api/{R:1}/{R:2}" />
        </rule>

        <rule name="ApiProxyMonitoringConfig" stopProcessing="true">
          <match url="^api/MonitoringConfig/?(.*)" />
          <action type="Rewrite" url="http://localhost:5029/api/MonitoringConfig/{R:1}" />
        </rule>

        <rule name="ApiProxyGeofence" stopProcessing="true">
          <match url="^api/(Geofence|Boundary|StayOnArea|Overpopulating)/?(.*)" />
          <action type="Rewrite" url="http://localhost:5030/api/{R:1}/{R:2}" />
        </rule>

        <rule name="ApiProxyAnalytics" stopProcessing="true">
          <match url="^api/(AlarmAnalytics|AlarmAnalyticsIncident|TrackingAnalytics|Dashboard)/(.*)" />
          <action type="Rewrite" url="http://localhost:5031/api/{R:1}/{R:2}" />
        </rule>

        <rule name="ApiProxyJobsScheduler" stopProcessing="true">
          <match url="^api/JobsScheduler/?(.*)" />
          <action type="Rewrite" url="http://localhost:5032/api/JobsScheduler/{R:1}" />
        </rule>

      </rules>
    </rewrite>
  </system.webServer>
</configuration>
